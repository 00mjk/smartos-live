/*
 * CDDL HEADER START
 *
 * The contents of this file are subject to the terms of the
 * Common Development and Distribution License, Version 1.0 only
 * (the "License").  You may not use this file except in compliance
 * with the License.
 *
 * You can obtain a copy of the license at http://smartos.org/CDDL
 *
 * See the License for the specific language governing permissions
 * and limitations under the License.
 *
 * When distributing Covered Code, include this CDDL HEADER in each
 * file.
 *
 * If applicable, add the following below this CDDL HEADER, with the
 * fields enclosed by brackets "[]" replaced with your own identifying
 * information: Portions Copyright [yyyy] [name of copyright owner]
 *
 * CDDL HEADER END
 *
 * Copyright (c) 2014, Joyent, Inc. All rights reserved.
 *
 */

var assert = require('assert');
var async = require('/usr/node/node_modules/async');
var bunyan = require('/usr/node/node_modules/bunyan');
var cp = require('child_process');
var EventEmitter = require('events').EventEmitter;
var FsWatcher = require('vmevent/fswatcher').FsWatcher;
var fs = require('fs');
var getZoneData = require('/usr/vm/node_modules/vmload').getZoneData;
var path = require('path');
var spawn = cp.spawn;
var ZoneWatcher = require('vmevent/zonewatcher').ZoneWatcher;
var ZpoolWatcher = require('vmevent/zpoolwatcher').ZpoolWatcher;

var log = bunyan.createLogger({
    level: 'trace',
    name: 'vminfod',
    streams: [ { stream: process.stderr, level: 'trace' } ],
    serializers: bunyan.stdSerializers
});

var event_queue;
var fsw;
var vm_data;
var zoneevent;
var zpoolevent;

var CONFIG_FILES = [
    'metadata.json',
    'routes.json',
    'tags.json'
];

function handleFsEvent(obj) {
    console.log('FS: ' + JSON.stringify(obj));
}

function handleZoneEvent(obj) {
    console.log('ZONE: ' + JSON.stringify(obj));
}

function handleZpoolEvent(obj) {
    console.log('ZPOOL: ' + JSON.stringify(obj));
}

function startWatchers(callback) {
    async.series([
        function (cb) {
            fsw = new FsWatcher({log: log, dedup_ns: 2000000000});

            fsw.on('all', handleFsEvent);
            fsw.once('ready', function (obj) {
                cb();
            });

            fsw.start();
        }, function (cb) {
            fsw.watch('/etc/zones', cb);
        }, function (cb) {
            fsw.watch('/tmp/.sysinfo.json', cb);
        }, function (cb) {
            zonew = new ZoneWatcher({log: log});

            zonew.on('all', handleZoneEvent);
            zonew.once('ready', function (obj) {
                cb();
            });

            zonew.start();
        }, function (cb) {
            zpoolw = new ZpoolWatcher({log: log});

            zpoolw.on('all', handleZpoolEvent);
            zpoolw.once('ready', function (obj) {
                cb();
            });

            zpoolw.start();
        }
    ], function (err) {
        callback(err);
    });
}

/*
 *
 *  zoneobj will look like:
 *
 *    {
 *     "zoneid": 1,
 *     "zonename": "5e9d36e3-c597-4b8e-8a51-55a7af9b8ac6",
 *     "state": "running",
 *     "zonepath": "/zones/5e9d36e3-c597-4b8e-8a51-55a7af9b8ac6",
 *     "uuid": "5e9d36e3-c597-4b8e-8a51-55a7af9b8ac6",
 *     "brand": "joyent-minimal",
 *     "ip_type": "excl"
 *   },
 */
function addVMFsWatches(zoneobj)
{
    var zonename = zoneobj.zonename;

    function watch(pathname) {
        fsw.watch(pathname, function (err) {
            if (err) {
                log.warn(err, 'failed to setup watch');
                return;
            }
            log.debug('now watching ' + pathname);
        });
    }

    watch('/etc/zones/' + zonename + '.xml');

    CONFIG_FILES.forEach(function (f) {
        watch('/zones/' + zonename + '/config/' + f);
    });
}

function main() {

    async.series([
        startWatchers,
        function (cb) {
            getZoneData(null, {log: log}, function (err, cache) {
                vm_data = cache;
                console.log('initial vm_data: ' + JSON.stringify(vm_data, null, 2));
                cb();
            });
        }, function (cb) {
            var vms = Object.keys(vm_data.zoneadm_objects);

            // XXX is this zonename or uuid?
            vms.forEach(function (zonename) {
                addVMFsWatches(vm_data.zoneadm_objects[zonename]);
            });
            cb();
        }
    ], function (err) {
        console.error('XXX DONE');
    });
}

main();


/*
 * TODO:
 *
 * events to a queue?
 * watch for dladm changes for vnics
 * watch for rctl changes
 *
 */

